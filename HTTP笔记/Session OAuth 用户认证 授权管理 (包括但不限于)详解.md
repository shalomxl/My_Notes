# JWT Cookie/Session OAuth ç”¨æˆ·è®¤è¯ æŽˆæƒç®¡ç† (åŒ…æ‹¬ä½†ä¸é™äºŽ)è¯¦è§£

å…ˆæ¥æ¢³ç†ä¸€ä¸‹ç”¨æˆ·äº¤äº’&ç™»é™†å…¨æµç¨‹å§

## ç”¨æˆ·ç™»é™†&äº¤äº’å…¨æµç¨‹

1. ç¬¬ä¸€æ­¥å…ˆè¿›è¡Œ**èº«ä»½è®¤è¯**ï¼Œèº«ä»½è®¤è¯æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š

    * è´¦æˆ·å¯†ç 
    * éªŒè¯ç (é‚®ç®±ã€æ‰‹æœºå·â€¦â€¦)
    * ç¬¬ä¸‰æŽˆä¿¡æ–¹éªŒè¯(è°·æ­ŒéªŒè¯â€¦â€¦)
    * ç”Ÿç‰©éªŒè¯(äººè„¸è¯†åˆ«ã€æŒ‡çº¹è§£é”â€¦â€¦)
    * äºŒæ¬¡éªŒè¯

2. è®¤è¯æˆåŠŸåŽï¼Œä¸ºäº†è®©æœåŠ¡å™¨çŸ¥é“åŽç»­æ“ä½œæ˜¯è°ï¼Œå°±éœ€è¦**ç»´æŒä¸Šä¸‹æ–‡çŠ¶æ€**ï¼Œå®žçŽ°æ–¹å¼ä¹Ÿæœ‰å¦‚ä¸‹å‡ ç§ï¼š

    * ä½¿ç”¨ Cookie/Session æ¥ç»´æŒ
    * ä½¿ç”¨ JWT

> è¡¥å……â›½ï¸ï¼šHTTPä¹Ÿæä¾›äº†èº«ä»½è®¤è¯çš„æ ‡å‡†ï¼Œä¸è¿‡ç›®å‰ä½¿ç”¨ä¸å¤ªå¹¿æ³›ï¼ŒðŸ”—[HTTP èº«ä»½éªŒè¯](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Authentication)

***

## èº«ä»½è®¤è¯

èº«ä»½è®¤è¯ç›®çš„æ˜¯**è®©æœåŠ¡å™¨çŸ¥é“ä½ åˆ°åº•æ˜¯è°ï¼ŒéšåŽæœåŠ¡å™¨å†æ ¹æ®ä½ çš„èº«ä»½ï¼Œå¼€æ”¾ç›¸åº”çš„æƒé™**ã€‚ç¨å¾®å®Œå–„çš„ç½‘ç«™ï¼Œéƒ½ä¼šæä¾›ç”¨æˆ·å¤šä¸ªç™»é™†é€”å¾„ï¼Œä»¥é˜²æŸå•ä¸€æ–¹æ³•å¤±è´¥ï¼Œå¯¼è‡´ç”¨æˆ·æ— æ³•ä½¿ç”¨æ•´ä¸ªç½‘ç«™ã€‚

### è´¦æˆ·å¯†ç 

è´¦æˆ·å¯†ç æ˜¯æœ€ä¼ ç»Ÿçš„ä¸€ç§æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ˜¯å­˜åœ¨ä¸€äº›é£Žé™©çš„ï¼Œæœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µå¯èƒ½ä¼šå‡ºçŽ°å¯†ç æ³„éœ²ï¼š

* å®¢æˆ·ç«¯ï¼šæš´åŠ›ç ´è§£
    > é»‘å®¢é€šè¿‡ç¨‹åºä¸æ–­çš„ç©·ä¸¾ï¼Œç›´è‡³æˆåŠŸè¯•å‡ºæ­£ç¡®çš„å¯†ç ã€‚
* ä¼ è¾“å±‚ï¼šå¯†ç ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æŠ“åŒ…
    > å¯†ç æ˜Žæ–‡ä¼ è¾“ï¼›æˆ–è€…é»‘å®¢æ‹¥æœ‰ä¸€ä¸ªMD5åº“ï¼Œå¯ä»¥å°†ç®€å•çš„å¯†ç æ‘˜è¦è¿›è¡Œç ´è§£ã€‚
* æœåŠ¡ç«¯ï¼šæ•°æ®åº“è¢«æ”»ç ´ï¼Œå¯†ç è¢«è¯»å–æˆ–è€…ä¿®æ”¹

å¯¹åº”è§£å†³æ–¹æ¡ˆï¼š

* å®¢æˆ·ç«¯ï¼šå¢žåŠ å¯†ç é˜²æŠ¤æœºåˆ¶ï¼Œæ¯”å¦‚è¿žç»­5æ¬¡é”™è¯¯åŽæš‚åœ5åˆ†é’Ÿâ€¦â€¦

* ä¼ è¾“å±‚ï¼šå®¢æˆ·ç«¯å°†å¯†é’¥åŠ å¯†ï¼ŒåŒæ—¶ä½¿ç”¨åŠ å¯†ä¼ è¾“åè®®ï¼Œæ¯”å¦‚[HTTPS](TODO)

* æœåŠ¡ç«¯ï¼š

    1. ä¸ä½¿ç”¨æ˜Žæ–‡å­˜å‚¨å¯†ç 
    2. åŠ ç›å­—æ®µ
    3. ä½¿ç”¨ä¸å¯é€†çš„åŠ å¯†ç®—æ³•è®¡ç®—å¯†æ–‡ï¼Œå­˜å‚¨å¯†æ–‡ï¼Œå‡ ç§åŠ å¯†ç®—æ³•ç®€ä»‹ðŸ”—ï¼š[åŠ å¯†ç®—æ³•](TODO)
    4. å°†å¯†æ–‡ä¸Žè´¦å·IDç»‘å®šï¼Œè®¡ç®—å¯†æ–‡çš„æ—¶å€™fn(å¯†ç +ç›+è´¦å·ID)ï¼Œè¿™æ ·å³ä½¿è„±åº“ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•é€šè¿‡æ›´æ¢å¯†é’¥çš„æ–¹å¼æ¥æŽ§åˆ¶è´¦æˆ·

æœåŠ¡ç«¯çš„æ–¹æ¡ˆæ¯”è¾ƒæŠ½è±¡ï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªæ¡ˆä¾‹è¯´æ˜Žä¸€ä¸‹ã€‚

#### XXXé¡¹ç›®æ˜¯å¦‚ä½•å­˜å‚¨å¯†é’¥çš„ï¼Ÿ

è¿™æ˜¯ä¸€å¼ å­˜å‚¨ç®¡ç†å‘˜ä¿¡æ¯æ•°æ®åº“è¡¨ï¼š

```sql
-- ç®¡ç†å‘˜è¡¨
DROP TABLE IF EXISTS `t_admin`;
CREATE TABLE `t_admin` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `address` CHAR(42) UNIQUE NOT NULL COMMENT 'ç®¡ç†å‘˜åœ°å€',
    `salt` VARCHAR(18) NOT NULL COMMENT 'ç”Ÿæˆæ‘˜è¦çš„ç›',
    `digest` CHAR(64) NOT NULL COMMENT 'æ‘˜è¦',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

å…¶ä¸­ï¼š`salt`æ˜¯ç›ï¼Œ`digest`æ˜¯ç”¨æ¥æ ¡éªŒçš„æ‘˜è¦ï¼Œä¹Ÿå°±æ˜¯fn(å¯†ç +ç›+è´¦å·ID)è®¡ç®—å‡ºæ¥çš„ç»“æžœã€‚

ä¸‹é¢æ˜¯ç™»é™†éªŒè¯æ—¶çš„ä»£ç ï¼š

```golang
type LoginParam struct {
   Address  string `validate:"required"`
   Password string `validate:"required"`
}

func (l *LoginParam) Verify() (bool, error) {
   m := model.TAdmin{
      Address: l.Address,
   }
   one, err := m.One()
   if err != nil {
      return false, errors.Wrap(err, "TAdmin One error")
   }

   //  è®¡ç®—æ‘˜è¦çš„æ–¹å¼åœ¨è¿™é‡Œ
   digest := sha256.Sum256([]byte(strconv.Itoa(int(one.ID)) + one.Salt + l.Password))

   return strings.ToUpper(hex.EncodeToString(digest[:])) == strings.ToUpper(one.Digest), nil
}
```

è§£é‡Šä¸€ä¸‹ä¸Šè¿°ä»£ç æœ€å…³é”®çš„ä¸€è¡Œï¼šä½¿ç”¨sha256æ‘˜è¦ç®—æ³•ï¼Œå¯¹â€œè´¦å·ID+ç›+å¯†ç â€è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æŽ¥åŽçš„å­—ç¬¦ä¸²è®¡ç®—æ‘˜è¦ï¼ŒéšåŽå†ä¸Žæ•°æ®åº“ä¸­è®°å½•çš„æ‘˜è¦ç›¸æ¯”è¾ƒã€‚

#### è¿™ä¹ˆåšçš„å¥½å¤„åœ¨å“ªï¼Ÿ

* é¦–å…ˆï¼Œæ²¡æœ‰å­˜å‚¨æ˜Žæ–‡ï¼Œè¿™æ ·å³ä½¿æ•°æ®åº“è¢«æ”»å‡»ï¼Œé»‘å®¢ä¹Ÿæ— æ³•å¾—åˆ°ç”¨æˆ·çš„å¯†ç ã€‚

* å†è€…ï¼Œå³ä½¿é»‘å®¢å°†æ‰€æœ‰è´¦æˆ·çš„æ‘˜è¦æ›¿æ¢æˆä»–è‡ªå·±è´¦æˆ·çš„æ‘˜è¦ï¼Œå› ä¸ºéªŒè¯çš„æ—¶å€™éœ€è¦ä¸Žè´¦æˆ·çš„IDæ‹¼æŽ¥ï¼Œæ‰€ä»¥è®¡ç®—å‡ºæ‘˜è¦è¿˜æ˜¯ä¸æ­£ç¡®çš„ã€‚

* æœ€åŽï¼Œè‹¥é»‘å®¢å°†IDå’Œç›éƒ½ä¿®æ”¹ï¼Œé‚£ä¹ˆåŽŸæœ¬æ”»å‡»çš„é‚£ä¸ªè´¦æˆ·æ‰€æœ‰çš„æƒé™ä¸Žèµ„æºå°±éƒ½å¤±æ•ˆäº†ï¼Œå› ä¸ºä¸šåŠ¡é€»è¾‘ä¸Šæ˜¯ä¸ŽIDç»‘å®šçš„ã€‚

è¿™æ ·ï¼Œå³ä½¿é»‘å®¢èŽ·å–äº†æ•°æ®åº“ç”¨æˆ·è¡¨çš„ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•ç™»é™†å…¶ä»–è´¦æˆ·ã€‚

### éªŒè¯ç è®¤è¯

éªŒè¯ç ä¸»è¦æ˜¯ä¾èµ–æ‰‹æœºå’Œé‚®ç®±çš„ç¨€ç¼ºæ€§ï¼Œæ‰‹æœºçš„ç¨€ç¼ºæ€§è¦é«˜äºŽé‚®ç®±ã€‚

### ç¬¬ä¸‰æŽˆä¿¡æ–¹è®¤è¯

ä¾èµ–ç¬¬ä¸‰æ–¹å¯ä»¥ä¿¡ä»»çš„å¹³å°ç™»é™†ï¼Œæ¯”å¦‚ï¼šè°·æ­Œã€GitHubã€å¾®ä¿¡ç­‰â€¦â€¦

è¿™é‡Œæœ‰ä¸¤ä¸ªæ¦‚å¿µå®¹æ˜“æ··æ·†ï¼šOAuth ä¸Ž èº«ä»½è®¤è¯ã€‚ä¸€èˆ¬è°·æ­Œæœç´¢ç¬¬ä¸‰æ–¹ç™»é™†ï¼Œéƒ½ä¼šæ‰¾åˆ°è®¸å¤šOAuthç›¸å…³çš„å†…å®¹ï¼Œä½†æ˜¯OAuthä¸Žæˆ‘ä»¬éœ€è¦çš„èº«ä»½è®¤è¯æ˜¯æœ‰å¾ˆå¤§çš„ä¸åŒçš„ï¼ŒåŒæ—¶ä¹Ÿä¸å¤ªé€‚åˆç”¨æ¥åšèº«ä»½è®¤è¯ã€‚

OAuthæ˜¯ç”¨æ¥æŽˆæƒçš„ï¼Œä¸»ä½“æ˜¯ç¬¬ä¸‰æ–¹è´¦æˆ·ç³»ç»Ÿã€‚æ¯”å¦‚è°·æ­Œçš„OAuthï¼ŒèŽ·å¾—è´¦æˆ·è®¸å¯åŽï¼Œå¯ä»¥èŽ·å¾—æ“ä½œç”¨æˆ·è°·æ­Œäº‘ç›˜çš„æƒé™ã€‚è€Œè°·æ­Œç¬¬ä¸‰æ–¹ç™»é™†åˆ™æ˜¯ç”±å¦å¤–çš„æŽ¥å£æä¾›ã€‚

é“¾æŽ¥ðŸ”—ï¼š

* [è°·æ­Œç™»å½•æ–‡æ¡£](https://developers.google.com/identity/gsi/web/guides/overview?hl=en)
    > æ³¨æ„âš ï¸ï¼šè°·æ­Œç¬¬ä¸‰æ–¹ç™»å½•æœ‰æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ—§ç‰ˆå°†ä¼šåœæ­¢è¿è¥ï¼Œä¸è¦æ‰¾é”™äº†ç‰ˆæœ¬ã€‚

* [è°·æ­ŒOAuthæ–‡æ¡£](https://developers.google.com/identity/protocols/oauth2/web-server?hl=en)

* ä½¿ç”¨å‰ï¼Œå»ºè®®å…ˆäº†è§£å…¶åŽŸç†ï¼š[OAuth 2.0 çš„ä¸€ä¸ªç®€å•è§£é‡Š - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](https://www.ruanyifeng.com/blog/2019/04/oauth_design.html) ï½œ [OAuth 2.0 çš„å››ç§æ–¹å¼ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html) ï½œ [GitHub OAuth ç¬¬ä¸‰æ–¹ç™»å½•ç¤ºä¾‹æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](https://www.ruanyifeng.com/blog/2019/04/github-oauth.html)

#### è°·æ­Œç™»é™†(Sign in with Google)

TODO

#### OAuth

TODO

##### è°·æ­ŒOAuthå®žè·µ

TODO

### ç”Ÿç‰©è®¤è¯

TODO

### äºŒæ¬¡éªŒè¯(åŒé‡è®¤è¯)

äºŒæ¬¡éªŒè¯æ˜¯æŒ‡ç”¨æˆ·ç™»å½•åŽï¼Œéœ€è¦å†æ¬¡è¾“å…¥åŠ¨æ€å£ä»¤ï¼Œæ‰å¯ä»¥å®Œæˆç™»é™†è¿‡ç¨‹ã€‚å…¸åž‹çš„äºŒæ¬¡éªŒè¯åº”ç”¨æœ‰è°·æ­Œçš„Authenticatoråº”ç”¨ã€‚è®¸å¤šå®‰å…¨æ€§æ¯”è¾ƒé«˜çš„ç½‘ç«™éƒ½ä¼šé‡‡ç”¨ç±»å·¥å…·æ¥éªŒè¯ç™»å½•ã€‚

#### åŽŸç†

å…¶åŽŸç†æ˜¯ï¼šé€šè¿‡ä¸€è‡´æ€§ç®—æ³•ï¼Œä½¿å®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯è®¡ç®—å‡ºç›¸åŒçš„åŠ¨æ€å£ä»¤ï¼Œå¹¶ä¸”æ¯30ç§’æ›´æ”¹å£ä»¤ã€‚å¤§å¤šæ•°åŒé‡è®¤è¯éƒ½é‡‡ç”¨TOTP ç®—æ³•ðŸ”—[åŸºäºŽæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ç®—æ³•-WIKI](https://zh.wikipedia.org/wiki/%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E4%B8%80%E6%AC%A1%E6%80%A7%E5%AF%86%E7%A0%81%E7%AE%97%E6%B3%95) ï¼Œå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯éœ€è¦ä¸€ä¸ªå®‰å…¨çš„é€šé“æ¥å…±äº«å¯†é’¥ï¼Œå¹¶ä¸”ä¸¤è€…æ—¶é’Ÿéœ€è¦åŒæ­¥ã€‚

#### GolangæœåŠ¡ç«¯ä»£ç å®žçŽ°

##### å¯†é’¥

###### ç”Ÿæˆå¯†é’¥(åŸºäºŽæ—¶é—´)

æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°å¾®ç§’ï¼Œé™¤ä»¥1000ï¼Œé™¤ä»¥30ï¼ˆåŠ¨æ€6ä½æ•°å­—æ¯30ç§’å˜åŒ–ä¸€æ¬¡ï¼‰

2. å¯¹æ—¶é—´æˆ³ä½™æ•° hmac_sha1 ç¼–ç 

3. ç„¶åŽ base32 encode æ ‡å‡†ç¼–ç 

4. è¾“å‡ºå¤§å†™å­—ç¬¦ä¸²ï¼Œå³ç§˜é’¥

ä»£ç ï¼š

```golang

type GoogleAuth struct {
}

//  1. èŽ·å¾—æ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°å¾®ç§’ï¼Œé™¤ä»¥1000ï¼Œé™¤ä»¥30ï¼ˆåŠ¨æ€6ä½æ•°å­—æ¯30ç§’å˜åŒ–ä¸€æ¬¡ï¼‰
func (g *GoogleAuth) un() int64 {
   return time.Now().UnixNano() / 1000 / 30
}

// 2. å¯¹æ—¶é—´æˆ³ä½™æ•° hmac_sha1 ç¼–ç 
func (g *GoogleAuth) hmacSha1(key, data []byte) []byte {
   h := hmac.New(sha1.New, key)
   if total := len(data); total > 0 {
      h.Write(data)
   }
   return h.Sum(nil)
}

// 3. ç„¶åŽ base32 encode æ ‡å‡†ç¼–ç 
func (g *GoogleAuth) base32encode(src []byte) string {
   return base32.StdEncoding.EncodeToString(src)
}

// èŽ·å–ç§˜é’¥ï¼Œæ—¶é—´ç›¸å…³
func (g *GoogleAuth) GetSecret() string {
   var buf bytes.Buffer
   binary.Write(&buf, binary.BigEndian, g.un())
   // 4. è¾“å‡ºå¤§å†™å­—ç¬¦ä¸²ï¼Œå³ç§˜é’¥
   return strings.ToUpper(g.base32encode(g.hmacSha1(buf.Bytes(), nil)))
}

```

###### å…±äº«å¯†é’¥

åœ¨ç”¨æˆ·ç™»é™†ä¹‹åŽï¼Œè®¾ç½®å¼€å¯åŒé‡è®¤è¯æ—¶ï¼Œé€šè¿‡äºŒç»´ç æ˜¾ç¤ºç”¨æˆ·å¯†é’¥ï¼Œç”¨æˆ·ä½¿ç”¨ Google Authenticator å®¢æˆ·ç«¯æ‰«ç ï¼Œå°†æ­¤ç§˜é’¥æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚

```golang

// èŽ·å–å¯†é’¥äºŒç»´ç å†…å®¹
func (g *GoogleAuth) GetQrcode(user, secret string) string {
   return fmt.Sprintf("otpauth://totp/%s?secret=%s", user, secret)
}

// èŽ·å–å¯†é’¥äºŒç»´ç å›¾ç‰‡åœ°å€,è¿™é‡Œæ˜¯ç¬¬ä¸‰æ–¹äºŒç»´ç api
func (g *GoogleAuth) GetQrcodeUrl(user, secret string) string {
   qrcode := g.GetQrcode(user, secret)
   width := "200"
   height := "200"
   data := url.Values{}
   data.Set("data", qrcode)
   return "https://api.qrserver.com/v1/create-qr-code/?" + data.Encode() + "&size=" + width + "x" + height + "&ecc=M"
}

```

##### å®žçŽ°ä¸ŽGoogle Authenticatorä¸€è‡´çš„ç®—æ³•

ç®—æ³•å¤ªå¤æ‚ï¼Œæˆ‘ä¹Ÿæ²¡å¼„æ˜Žç™½ï¼Œæš‚æ—¶ç›´æŽ¥è´´ä»£ç å§ï¼š

```golang

// èŽ·å–åŠ¨æ€ç 
func (g *GoogleAuth) GetCode(secret string) (string, error) {
   secretUpper := strings.ToUpper(secret)
   // 1. base32 è§£ç 
   secretKey, err := g.base32decode(secretUpper)
   if err != nil {
      return "", err
   }
   number := g.oneTimePassword(secretKey, g.toBytes(time.Now().Unix()/30))
   return fmt.Sprintf("%06d", number), nil
}

func (g *GoogleAuth) base32decode(s string) ([]byte, error) {
   return base32.StdEncoding.DecodeString(s)
}

func (g *GoogleAuth) toBytes(value int64) []byte {
   var result []byte
   mask := int64(0xFF)
   shifts := [8]uint16{56, 48, 40, 32, 24, 16, 8, 0}
   for _, shift := range shifts {
      result = append(result, byte((value>>shift)&mask))
   }
   return result
}

func (g *GoogleAuth) toUint32(bts []byte) uint32 {
   return (uint32(bts[0]) << 24) + (uint32(bts[1]) << 16) +
      (uint32(bts[2]) << 8) + uint32(bts[3])
}

func (g *GoogleAuth) oneTimePassword(key []byte, data []byte) uint32 {
   // å¯¹å¯†é’¥å’Œæ—¶é—´ä½™æ•°è¿›è¡Œ hmac_sha1 ç¼–ç 
   hash := g.hmacSha1(key, data)
   offset := hash[len(hash)-1] & 0x0F
   hashParts := hash[offset : offset+4]
   hashParts[0] = hashParts[0] & 0x7F
   number := g.toUint32(hashParts)
   return number % 1000000
}

```

## ç»´æŒä¸Šä¸‹æ–‡çŠ¶æ€

